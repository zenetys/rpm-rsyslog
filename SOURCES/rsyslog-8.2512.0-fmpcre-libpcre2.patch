From 347717e3b9c6ab828467b4d191160cf3b1338f6e Mon Sep 17 00:00:00 2001
From: Julien Thomas <jthomas@zenetys.com>
Date: Thu, 5 Feb 2026 20:11:41 +0100
Subject: [PATCH] MAJOR: fmpcre: Migrate to libpcre2

This migrates the fmpcre function module from the legacy libpcre
library to the modern libpcre2 API.

Key changes:
- Replace pcre_compile() with pcre2_compile()
- Replace pcre_exec() with pcre2_match()
- Add proper match_data allocation and cleanup
- Update error handling to use pcre2_get_error_message()
- Update configure.ac to detect libpcre2-8 instead of libpcre
- Update build configuration to link against libpcre2

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
---
 configure.ac               | 17 +++++++++--------
 plugins/fmpcre/Makefile.am |  4 ++--
 plugins/fmpcre/README.md   |  6 +++---
 plugins/fmpcre/fmpcre.c    | 32 +++++++++++++++++++++-----------
 4 files changed, 35 insertions(+), 24 deletions(-)

diff --git a/configure.ac b/configure.ac
index 62d8131c4..6e70ce33c 100644
--- a/configure.ac
+++ b/configure.ac
@@ -537,14 +537,15 @@ AC_ARG_ENABLE(fmpcre,
        [enable_fmpcre=no]
 )
 if test "x$enable_fmpcre" = "xyes"; then
-       AC_CHECK_LIB([pcre], [pcre_exec], [
-               AC_CHECK_HEADER([pcre.h], [
-                       PCRE_LIBS="-lpcre"
-                       PCRE_CFLAGS=""
-                       AC_SUBST(PCRE_LIBS)
-                       AC_SUBST(PCRE_CFLAGS)
-               ], [AC_MSG_ERROR([pcre headers not found])])
-       ], [AC_MSG_ERROR([libpcre not found])])
+       AC_CHECK_LIB([pcre2-8], [pcre2_compile_8], [
+               AC_CHECK_HEADER([pcre2.h], [
+                       PCRE2_LIBS="-lpcre2-8"
+                       PCRE2_CFLAGS=""
+                       AC_SUBST(PCRE2_LIBS)
+                       AC_SUBST(PCRE2_CFLAGS)
+               ], [AC_MSG_ERROR([pcre2 headers not found])],
+                  [#define PCRE2_CODE_UNIT_WIDTH 8])
+       ], [AC_MSG_ERROR([libpcre2-8 not found])])
 fi
 AM_CONDITIONAL(ENABLE_FMPCRE, test x$enable_fmpcre = xyes)
 
diff --git a/plugins/fmpcre/Makefile.am b/plugins/fmpcre/Makefile.am
index fcdf7e64c..06afe9950 100644
--- a/plugins/fmpcre/Makefile.am
+++ b/plugins/fmpcre/Makefile.am
@@ -1,5 +1,5 @@
 pkglib_LTLIBRARIES = fmpcre.la
 fmpcre_la_SOURCES = fmpcre.c
-fmpcre_la_CPPFLAGS = $(PTHREADS_CFLAGS) $(RSRT_CFLAGS) $(PCRE_CFLAGS)
+fmpcre_la_CPPFLAGS = $(PTHREADS_CFLAGS) $(RSRT_CFLAGS) $(PCRE2_CFLAGS)
 fmpcre_la_LDFLAGS = -module -avoid-version
-fmpcre_la_LIBADD = $(PCRE_LIBS)
+fmpcre_la_LIBADD = $(PCRE2_LIBS)
diff --git a/plugins/fmpcre/README.md b/plugins/fmpcre/README.md
index a0d40ad7b..126c93b9d 100644
--- a/plugins/fmpcre/README.md
+++ b/plugins/fmpcre/README.md
@@ -1,11 +1,11 @@
-# fmpcre - PCRE-based matching function
+# fmpcre - PCRE2-based matching function
 
 This optional RainerScript function module provides `pcre_match()`. It allows
-checking whether a given string matches a PCRE regular expression.
+checking whether a given string matches a PCRE2 regular expression.
 
 ## Build
 
-Install the PCRE development library (e.g. `libpcre3-dev` on Debian/Ubuntu) and
+Install the PCRE2 development library (e.g. `libpcre2-dev` on Debian/Ubuntu) and
 enable the module during configure:
 
 ```bash
diff --git a/plugins/fmpcre/fmpcre.c b/plugins/fmpcre/fmpcre.c
index 50770db63..0e93ee504 100644
--- a/plugins/fmpcre/fmpcre.c
+++ b/plugins/fmpcre/fmpcre.c
@@ -12,7 +12,8 @@
     #include <typedefs.h>
 #endif
 #include <sys/types.h>
-#include <pcre.h>
+#define PCRE2_CODE_UNIT_WIDTH 8
+#include <pcre2.h>
 #include <string.h>
 
 #include "rsyslog.h"
@@ -25,7 +26,7 @@ MODULE_TYPE_NOKEEP
 DEF_FMOD_STATIC_DATA;
 
 struct pcre_state {
-    pcre *re;
+    pcre2_code *re;
 };
 
 static void ATTR_NONNULL() doFunc_pcre_match(struct cnffunc *__restrict__ const func,
@@ -37,23 +38,30 @@ static void ATTR_NONNULL() doFunc_pcre_match(struct cnffunc *__restrict__ const
     int bMustFree;
     char *str;
     int rc;
+    pcre2_match_data *match_data;
+
+    ret->datatype = 'N';
+    ret->d.n = 0;
 
     cnfexprEval(func->expr[0], &srcVal, usrptr, pWti);
     str = (char *)var2CString(&srcVal, &bMustFree);
-    rc = pcre_exec(state->re, NULL, str, strlen(str), 0, 0, NULL, 0);
+    match_data = pcre2_match_data_create_from_pattern(state->re, NULL);
+    if (match_data == NULL)
+        goto finalize_it;
+    rc = pcre2_match(state->re, (PCRE2_SPTR)str, strlen(str), 0, 0, match_data, NULL);
+    pcre2_match_data_free(match_data);
     if (rc >= 0)
         ret->d.n = 1;
-    else
-        ret->d.n = 0;
-    ret->datatype = 'N';
+
+finalize_it:
     if (bMustFree) free(str);
     varFreeMembers(&srcVal);
 }
 
 static rsRetVal ATTR_NONNULL(1) initFunc_pcre_match(struct cnffunc *const func) {
     DEFiRet;
-    const char *err;
-    int erroffset;
+    int errorcode;
+    PCRE2_SIZE erroffset;
     char *regex = NULL;
     struct pcre_state *state;
 
@@ -68,9 +76,11 @@ static rsRetVal ATTR_NONNULL(1) initFunc_pcre_match(struct cnffunc *const func)
 
     CHKmalloc(state = calloc(1, sizeof(struct pcre_state)));
     regex = es_str2cstr(((struct cnfstringval *)func->expr[1])->estr, NULL);
-    state->re = pcre_compile(regex, 0, &err, &erroffset, NULL);
+    state->re = pcre2_compile((PCRE2_SPTR)regex, PCRE2_ZERO_TERMINATED, 0, &errorcode, &erroffset, NULL);
     if (state->re == NULL) {
-        parser_errmsg("pcre compilation failed at offset %d: %s", erroffset, err);
+        PCRE2_UCHAR buffer[256];
+        pcre2_get_error_message(errorcode, buffer, sizeof(buffer));
+        parser_errmsg("pcre compilation failed at offset %zu: %s", (size_t)erroffset, buffer);
         free(state);
         ABORT_FINALIZE(RS_RET_ERR);
     }
@@ -85,7 +95,7 @@ finalize_it:
 static void ATTR_NONNULL(1) destruct_pcre(struct cnffunc *const func) {
     struct pcre_state *state = (struct pcre_state *)func->funcdata;
     if (state != NULL) {
-        if (state->re != NULL) pcre_free(state->re);
+        if (state->re != NULL) pcre2_code_free(state->re);
         free(state);
     }
 }
-- 
2.53.0

